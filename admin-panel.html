<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Nation Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3d6f 0%, #2c5aa0 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            margin: 2px 0;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Mathematics Statistics Cards Styling */
        .math-stats-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .math-stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .math-number {
            font-size: 3rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .math-label {
            font-size: 1rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        .math-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .math-action-link {
            font-size: 0.875rem;
            color: #6b7280;
            text-decoration: none;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .math-action-link:hover {
            color: #3b82f6;
            text-decoration: none;
        }

        .math-action-link i {
            font-size: 0.75rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .math-number {
                font-size: 2.5rem;
            }

            .math-label {
                font-size: 0.875rem;
            }

            .math-actions {
                flex-direction: column;
                gap: 0.25rem;
            }
        }
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        .btn-grant {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
        }
        .btn-revoke {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            border: none;
        }
        .search-box {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 10px 20px;
        }
        .search-box:focus {
            border-color: #1e3d6f;
            box-shadow: 0 0 0 0.2rem rgba(30, 61, 111, 0.25);
        }
        
        /* Prevent auto-capitalization on all inputs */
        input[type="text"], 
        input[type="email"], 
        input[type="password"], 
        input[type="tel"], 
        input[type="search"] {
            text-transform: none !important;
            -webkit-text-transform: none !important;
            -moz-text-transform: none !important;
            -ms-text-transform: none !important;
            -o-text-transform: none !important;
        }
        
        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        
        /* Improved table styling */
        .table-hover tbody tr:hover {
            background-color: rgba(30, 61, 111, 0.05);
        }
        
        /* Status badges */
        .badge {
            font-size: 0.75em;
        }
        
        /* Action buttons */
        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        
        /* Card improvements */
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .btn-action {
                padding: 0.125rem 0.25rem;
                font-size: 0.75rem;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .main-content {
                background: #1a1a1a;
                color: #ffffff;
            }
            
            .card {
                background: #2d2d2d;
                color: #ffffff;
            }
            
            .table {
                color: #ffffff;
            }
            
            .table-hover tbody tr:hover {
                background-color: rgba(255, 255, 255, 0.05);
            }
        }
    </style>
</head>
<body>
    

    <div class="container-fluid" id="mainContent" style="display: block;">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <h4 class="text-white mb-4">
                        <i class="bi bi-mortarboard me-2"></i>
                        IG Nation Admin
                    </h4>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard', this)">
                            <i class="bi bi-speedometer2 me-2"></i>
                            Dashboard
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('students', this)">
                            <i class="bi bi-people me-2"></i>
                            Students
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('teachers', this)">
                            <i class="bi bi-person-badge me-2"></i>
                            Teachers
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('parents', this)">
                            <i class="bi bi-people-fill me-2"></i>
                            Parents
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('courses', this)">
                            <i class="bi bi-book me-2"></i>
                            Courses
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('enrollments', this)">
                            <i class="bi bi-person-check me-2"></i>
                            Enrollments
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('orders', this)">
                            <i class="bi bi-cart-check me-2"></i>
                            Orders
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('questions', this)">
                            <i class="bi bi-question-circle me-2"></i>
                            Questions Management
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('course-analytics', this)">
                            <i class="bi bi-graph-up me-2"></i>
                            Course Analytics
                        </a>
                        <a class="nav-link" href="analytics.html" target="_blank">
                            <i class="bi bi-bar-chart me-2"></i>
                            Website Analytics
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="p-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 id="pageTitle">Dashboard</h2>
                        <div class="d-flex align-items-center">
                            <span class="me-3">Welcome, Admin</span>
                            <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                                <i class="bi bi-box-arrow-right me-1"></i>
                                Logout
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard Section -->
                    <div id="dashboard-section">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-people fs-1 mb-2"></i>
                                        <h3 id="totalStudents">0</h3>
                                        <p class="mb-0">Total Students</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-book fs-1 mb-2"></i>
                                        <h3 id="totalCourses">0</h3>
                                        <p class="mb-0">Active Courses</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-person-check fs-1 mb-2"></i>
                                        <h3 id="totalEnrollments">0</h3>
                                        <p class="mb-0">Active Enrollments</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-currency-pound fs-1 mb-2"></i>
                                        <h3 id="totalRevenue">0 EGP</h3>
                                        <p class="mb-0">Total Revenue</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4" id="quick-actions-section">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-white">
                                        <h5 class="mb-0">âš¡ Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <a href="admin-content-manager.html" class="text-decoration-none">
                                                    <div class="card h-100" style="border: 2px solid #667eea; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(102,126,234,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                                                        <div class="card-body text-center">
                                                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“</div>
                                                            <h5 style="color: #667eea; font-weight: 700;">Content Manager</h5>
                                                            <p class="text-muted mb-0" style="font-size: 0.9rem;">Manage videos and PDFs for all courses</p>
                                                        </div>
                                                    </div>
                                                </a>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card h-100" style="border: 2px solid #28a745; transition: all 0.3s; cursor: pointer;" onclick="showAddCourseModal()" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(40,167,69,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                                                    <div class="card-body text-center">
                                                        <i class="bi bi-plus-circle fs-1 mb-2"></i>
                                                        <h5 style="color: #28a745; font-weight: 700;">Add New Course</h5>
                                                        <p class="text-muted mb-0" style="font-size: 0.9rem;">Create a new course from scratch</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card h-100" style="border: 2px solid #f59e0b; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(245,158,11,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                                                    <div class="card-body text-center">
                                                        <i class="bi bi-graph-up fs-1 mb-2"></i>
                                                        <h5 style="color: #f59e0b; font-weight: 700;">View Reports</h5>
                                                        <p class="text-muted mb-0" style="font-size: 0.9rem;">Access detailed analytics and reports</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Recent Activity</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentActivity">
                                            <p class="text-muted">Loading recent activity...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Students Section -->
                    <div id="students-section" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Student Management</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-success btn-sm" onclick="exportStudents()" title="Export to CSV (Ctrl+E)">
                                        <i class="bi bi-download"></i> Export
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadStudents()" title="Refresh (Ctrl+R)">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control search-box" id="studentSearch" placeholder="Search by email or name...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="searchStudents()">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Parent Phone</th>
                                                <th>Joined</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentsTable">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading students...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Details Modal -->
                    <div class="modal fade" id="studentDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Student Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <h6 class="mb-3 text-primary">Personal Information</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>ID:</strong> <span id="studentId"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Role:</strong> <span id="studentRole"></span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>First Name:</strong> <span id="studentFirstName"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Last Name:</strong> <span id="studentLastName"></span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <strong>Email:</strong> <span id="studentEmail"></span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Phone:</strong> <span id="studentPhone"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Parent Phone:</strong> <span id="studentParentPhone"></span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Joined:</strong> <span id="studentJoined"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Last Login:</strong> <span id="studentLastLogin"></span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Points:</strong> <span id="studentPoints" class="badge bg-success fs-6"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Status:</strong> <span id="studentStatus"></span>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <strong>Password:</strong> <span id="studentPassword" class="text-muted">(hashed)</span>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyPassword()">
                                                <i class="bi bi-clipboard"></i> Copy Hash
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Last Updated:</strong> <span id="studentUpdated"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Account Status:</strong> <span id="studentAccountStatus"></span>
                                        </div>
                                    </div>
                                    
                                                                        
                                    <h6 class="mt-4 mb-3 text-primary">Student Activity & Progress</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title text-primary" id="studentTotalPoints">0</h5>
                                                    <p class="card-text">Total Points</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title text-success" id="studentEnrolledCourses">0</h5>
                                                    <p class="card-text">Enrolled Courses</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title text-info" id="studentDaysActive">0</h5>
                                                    <p class="card-text">Days Active</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6 class="mt-4 mb-3 text-primary">Enrolled Courses</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Course</th>
                                                    <th>Instructor</th>
                                                    <th>Price</th>
                                                    <th>Enrolled</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="studentEnrollments">
                                                <tr>
                                                    <td colspan="6" class="text-center">Loading enrollments...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                                                    </div>
                            </div>
                        </div>
                    </div>

                    <!-- Courses Section -->
                    <div id="courses-section" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Course Management</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Title</th>
                                                <th>Instructor</th>
                                                <th>Price</th>
                                                <th>Level</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="coursesTable">
                                            <tr>
                                                <td colspan="7" class="text-center">Loading courses...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Teachers Section -->
                    <div id="teachers-section" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Teacher Management</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadTeachers()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="showAddTeacherModal()">
                                        <i class="bi bi-plus-circle"></i> Add Teacher
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Subject</th>
                                                <th>Experience</th>
                                                <th>Assistants</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teachersTable">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading teachers...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Parents Section -->
                    <div id="parents-section" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Parent Management</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadParents()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="exportParents()">
                                        <i class="bi bi-download"></i> Export
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                                            <input type="text" class="form-control" id="parentSearchInput" placeholder="Search parents by name, email, or phone..." onkeyup="filterParents()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="parentStatusFilter" onchange="filterParents()">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="parentSortBy" onchange="sortParents()">
                                            <option value="name">Sort by Name</option>
                                            <option value="email">Sort by Email</option>
                                            <option value="created_at">Sort by Registration Date</option>
                                            <option value="last_login">Sort by Last Login</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Parents Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                                <th>Son/Daughter</th>
                                                <th>Registration Date</th>
                                                <th>Last Login</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="parentsTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center text-muted py-4">
                                                    <i class="bi bi-people-fill fs-1"></i>
                                                    <p class="mt-2">Loading parents...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <nav aria-label="Parents pagination">
                                    <ul class="pagination justify-content-center" id="parentsPagination">
                                        <!-- Pagination will be generated here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>


                    <!-- Enrollments Section -->
                    <div id="enrollments-section" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Enrollment Management</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Student</th>
                                                <th>Course</th>
                                                <th>Enrolled Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="enrollmentsTable">
                                            <tr>
                                                <td colspan="5" class="text-center">Loading enrollments...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Section -->
                    <div id="orders-section" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Order Management</h5>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-success btn-sm" onclick="exportOrders()" title="Export to CSV (Ctrl+E)">
                                        <i class="bi bi-download"></i> Export
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadOrders()" title="Refresh (Ctrl+R)">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Order ID</th>
                                                <th>Student</th>
                                                <th>Courses</th>
                                                <th>Amount</th>
                                                <th>Payment Method</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTable">
                                            <tr>
                                                <td colspan="7" class="text-center">Loading orders...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Management Section -->
                    <div id="questions-section" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-question-circle me-2"></i>
                                    Questions Management
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Course Selection -->
                                <div class="mb-4">
                                    <label for="questionCourseSelect" class="form-label fw-bold">Select Course:</label>
                                    <select class="form-select" id="questionCourseSelect" onchange="loadQuestions(this.value)">
                                        <option value="">Choose a course...</option>
                                        <option value="mathematics">Mathematics IGCSE</option>
                                        <option value="physics">Physics IGCSE</option>
                                        <option value="english">English IGCSE</option>
                                    </select>
                                </div>

                                <!-- Add Question Button -->
                                <div class="mb-4">
                                    <button class="btn btn-primary" onclick="showAddQuestionModal()">
                                        <i class="bi bi-plus-circle me-2"></i>
                                        Add New Question
                                    </button>
                                </div>

                                <!-- Questions List -->
                                <div id="questionsListContainer">
                                    <p class="text-muted text-center">Please select a course to view questions</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Course Analytics Section -->
                    <div id="course-analytics-section" style="display: none;">
                        <!-- Course Overview Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-book me-2" style="font-size: 2rem;"></i>
                                        <h4 id="analyticsTotalCourses">0</h4>
                                        <p class="mb-0">Total Courses</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                    <div class="card-body text-center">
                                        <i class="bi bi-people me-2" style="font-size: 2rem;"></i>
                                        <h4 id="analyticsTotalEnrollments">0</h4>
                                        <p class="mb-0">Total Enrollments</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
                                    <div class="card-body text-center">
                                        <i class="bi bi-trophy me-2" style="font-size: 2rem;"></i>
                                        <h4 id="analyticsTopPerformer">-</h4>
                                        <p class="mb-0">Top Performer</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
                                    <div class="card-body text-center">
                                        <i class="bi bi-graph-up me-2" style="font-size: 2rem;"></i>
                                        <h4 id="analyticsAvgPoints">0</h4>
                                        <p class="mb-0">Avg Points</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Students Per Course Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Students Registered Per Course</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="studentsPerCourseCards">
                                            <div class="col-12 text-center text-muted">
                                                <p>Loading course enrollment data...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Selection and Analytics -->
                        <div class="row">
                            <!-- Course Selection -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Select Course</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="courseSelect" class="form-label">Choose Course</label>
                                            <select class="form-select" id="courseSelect" onchange="loadCourseLeaderboard(this.value)">
                                                <option value="">Select a course...</option>
                                            </select>
                                        </div>
                                        <div id="courseInfo" style="display: none;">
                                            <div class="alert alert-info">
                                                <h6 id="selectedCourseName">Course Name</h6>
                                                <p class="mb-1"><strong>Students:</strong> <span id="courseStudentCount">0</span></p>
                                                <p class="mb-1"><strong>Duration:</strong> <span id="courseDuration">-</span></p>
                                                <p class="mb-0"><strong>Level:</strong> <span id="courseLevel">-</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Leaderboard -->
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Student Leaderboard</h5>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="refreshLeaderboard()">
                                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="exportLeaderboard()">
                                                <i class="bi bi-download me-1"></i>Export
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Name</th>
                                                        <th>Email</th>
                                                        <th>Phone</th>
                                                        <th>Parent Phone</th>
                                                        <th>Joined</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="leaderboardTable">
                                                    <tr>
                                                        <td colspan="6" class="text-center">Select a course to view leaderboard</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Performance Charts -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Course Performance</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="coursePerformanceChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Points Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="pointsDistributionChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Teacher Modal -->
    <div class="modal fade" id="addTeacherModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Teacher</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTeacherForm">
                        <div class="mb-3">
                            <label for="teacherName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="teacherName" required>
                        </div>
                        <div class="mb-3">
                            <label for="teacherEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="teacherEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="teacherSubject" class="form-label">Subject</label>
                            <select class="form-select" id="teacherSubject" required>
                                <option value="">Select Subject</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="English">English</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="teacherExperience" class="form-label">Years of Experience</label>
                            <input type="number" class="form-control" id="teacherExperience" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="teacherPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="teacherPhone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addTeacher()">Add Teacher</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Details Modal -->
    <div class="modal fade" id="teacherDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Teacher Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Teacher Information</h6>
                            <p><strong>Name:</strong> <span id="teacherDetailName"></span></p>
                            <p><strong>Email:</strong> <span id="teacherDetailEmail"></span></p>
                            <p><strong>Subject:</strong> <span id="teacherDetailSubject"></span></p>
                            <p><strong>Experience:</strong> <span id="teacherDetailExperience"></span> years</p>
                            <p><strong>Phone:</strong> <span id="teacherDetailPhone"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>Assistants</h6>
                            <div id="assistantsList">
                                <p class="text-muted">Loading assistants...</p>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="showAddAssistantModal()">
                                <i class="bi bi-plus"></i> Add Assistant
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTeacher()">Delete Teacher</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Assistant Modal -->
    <div class="modal fade" id="addAssistantModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Assistant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAssistantForm">
                        <div class="mb-3">
                            <label for="assistantName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="assistantName" required>
                        </div>
                        <div class="mb-3">
                            <label for="assistantEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="assistantEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="assistantPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="assistantPhone">
                        </div>
                        <div class="mb-3">
                            <label for="assistantRole" class="form-label">Role</label>
                            <select class="form-select" id="assistantRole" required>
                                <option value="">Select Role</option>
                                <option value="Teaching Assistant">Teaching Assistant</option>
                                <option value="Grading Assistant">Grading Assistant</option>
                                <option value="Content Creator">Content Creator</option>
                                <option value="Student Support">Student Support</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addAssistant()">Add Assistant</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Admin Panel</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let authToken = null;
        let currentStudentId = null;
        
        // Helper function to get API URL — always use same origin when on localhost so token from this server works
        function getApiUrl() {
            const origin = window.location.origin || '';
            if (origin.startsWith('http://localhost') || origin.startsWith('http://127.0.0.1')) {
                return origin + '/api';
            }
            if (window.API_CONFIG && window.API_CONFIG.apiURL) return window.API_CONFIG.apiURL;
            return origin + '/api';
        }

        function redirectToAdminLogin() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminEmail');
            localStorage.removeItem('adminToken');
            authToken = null;
            window.location.replace('admin-login.html');
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastBody = document.getElementById('toastBody');
            
            // Set message
            toastBody.textContent = message;
            
            // Set type-specific styling
            toast.className = `toast ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : 'bg-info text-white'}`;
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Loading state management
        function setLoading(elementId, isLoading) {
            const element = document.getElementById(elementId);
            if (element) {
                if (isLoading) {
                    element.classList.add('loading');
                } else {
                    element.classList.remove('loading');
                }
            }
        }

        // Initialize admin panel — require valid admin session or redirect to login
        document.addEventListener('DOMContentLoaded', function() {
            var qa = document.getElementById('quick-actions-section');
            if (qa) qa.remove();
            const savedToken = localStorage.getItem('adminToken');
            if (!savedToken) {
                redirectToAdminLogin();
                return;
            }
            authToken = savedToken;
            testAdminToken(savedToken);
            setInterval(() => {
                if (document.getElementById('students-section') && document.getElementById('students-section').style.display !== 'none') {
                    loadStudents();
                }
                if (document.getElementById('dashboard-section') && document.getElementById('dashboard-section').style.display !== 'none') {
                    loadDashboard();
                }
            }, 30000);
        });

        function showLoginModal() {}

        async function login(email, password) {
            try {
                // Use API_CONFIG if available, otherwise use Railway URL
                const apiUrl = (window.API_CONFIG && window.API_CONFIG.apiURL) || 'https://elbadry-production.up.railway.app/api';
                
                const response = await fetch(`${apiUrl}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    
                    // Hide login modal and show main content
                    const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if (modal) modal.hide();
                    
                    document.getElementById('mainContent').style.display = 'block';
                    loadDashboard();
                } else {
                    showToast('Login failed: ' + (data.error || 'Invalid credentials'), 'error');
                }
            } catch (error) {
                showToast('Login error: ' + error.message, 'error');
            }
        }

        // Login form removed

        function logout() {
            authToken = null;
            localStorage.removeItem('adminToken');
            document.getElementById('mainContent').style.display = 'block';
            loadDashboard();
        }

        async function apiCall(endpoint, options = {}) {
            // Build full URL when a relative path is provided
            const baseUrl = 'https://my-project-gphv.onrender.com';
            const url = endpoint.startsWith('http') ? endpoint : `${baseUrl}${endpoint.startsWith('/') ? '' : '/'}${endpoint}`;

            // Merge headers: preserve any custom headers, but always include Content-Type and Authorization when available
            const headers = Object.assign({}, {
                'Content-Type': 'application/json'
            }, options.headers || {});

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            console.log('API Call:', url, 'Token:', authToken ? 'Present' : 'Missing');

            const response = await fetch(url, Object.assign({}, options, { headers }));

            if (!response.ok) {
                const text = await response.text().catch(() => '');
                let errorData = { error: text || response.statusText };
                try {
                    errorData = JSON.parse(text || '{}');
                } catch (e) {
                    // ignore JSON parse error
                }
                console.error('API Error:', response.status, errorData);
                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
            }

            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                return await response.json();
            }

            return await response.text();
        }

        function showSection(sectionName, clickedElement = null) {
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Add active class to clicked nav link (if provided)
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                // Find the nav link for this section and make it active
                const navLink = document.querySelector(`[onclick*="showSection('${sectionName}')"]`);
                if (navLink) {
                    navLink.classList.add('active');
                }
            }
            
            // Update page title
            document.getElementById('pageTitle').textContent = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'teachers':
                    loadTeachers();
                    break;
                case 'parents':
                    loadParents();
                    break;
                case 'courses':
                    loadCourses();
                    break;
                case 'enrollments':
                    loadEnrollments();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'course-analytics':
                    loadCourseAnalytics();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                console.log('Loading dashboard with token:', authToken ? 'Present' : 'Missing');
                
                // Load stats: /api/admin/students returns users with role 'student' (registered on site)
                const [studentsRes, courses, enrollmentsData, ordersData] = await Promise.all([
                    apiCall('/api/admin/students'),
                    apiCall('/api/courses'),
                    apiCall('/api/admin/enrollments').catch(() => ({ enrollments: [] })),
                    apiCall('/api/admin/orders').catch(() => ({ orders: [] }))
                ]);

                const students = Array.isArray(studentsRes) ? studentsRes : [];
                const studentCount = students.length;
                
                // Extract arrays from response objects
                const enrollments = Array.isArray(enrollmentsData) ? enrollmentsData : (enrollmentsData.enrollments || []);
                const orders = Array.isArray(ordersData) ? ordersData : (ordersData.orders || []);

                console.log('Dashboard data:', { students: studentCount, courses: (courses && courses.length) || 0, enrollments: enrollments.length, orders: orders.length });

                document.getElementById('totalStudents').textContent = studentCount;
                document.getElementById('totalCourses').textContent = Array.isArray(courses) ? courses.length : 0;
                document.getElementById('totalEnrollments').textContent = enrollments.length;
                
                // Calculate revenue
                const revenue = orders.reduce((sum, order) => sum + (order.total_amount || 0), 0);
                document.getElementById('totalRevenue').textContent = revenue.toFixed(2) + ' EGP';


                // Load recent activity
                loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error loading dashboard data', 'error');
                // Set default values if API fails
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('totalCourses').textContent = '0';
                document.getElementById('totalEnrollments').textContent = '0';
                document.getElementById('totalRevenue').textContent = '0.00 EGP';
            }
        }




        async function loadRecentActivity() {
            try {
                const [enrollmentsData, ordersData] = await Promise.all([
                    apiCall('/api/admin/enrollments').catch(() => ({ enrollments: [] })),
                    apiCall('/api/admin/orders').catch(() => ({ orders: [] }))
                ]);
                
                // Extract arrays from response objects
                const enrollments = Array.isArray(enrollmentsData) ? enrollmentsData : (enrollmentsData.enrollments || []);
                const orders = Array.isArray(ordersData) ? ordersData : (ordersData.orders || []);
                
                const recentActivity = [
                    ...enrollments.slice(0, 3).map(e => ({
                        type: 'enrollment',
                        text: `${e.first_name} ${e.last_name} enrolled in ${e.course_title}`,
                        date: e.enrolled_at
                    })),
                    ...orders.slice(0, 3).map(o => {
                        // Get customer name from joined user data
                        const customerName = o.first_name && o.last_name 
                            ? `${o.first_name} ${o.last_name}` 
                            : (o.customer_name || 'A student');
                        
                        // Parse courses to get course names
                        let courseNames = 'a course';
                        try {
                            const courses = typeof o.courses === 'string' ? JSON.parse(o.courses) : o.courses;
                            if (Array.isArray(courses)) {
                                courseNames = courses.map(c => typeof c === 'string' ? c : (c.title || c.name || 'Unknown')).join(', ');
                            } else if (typeof courses === 'object' && courses.title) {
                                courseNames = courses.title;
                            }
                        } catch (e) {
                            console.error('Error parsing courses:', e);
                        }
                        
                        return {
                            type: 'order',
                            text: `${customerName} placed an order for ${courseNames} (${o.total_amount} EGP)`,
                            date: o.created_at
                        };
                    })
                ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                
                if (recentActivity.length === 0) {
                    document.getElementById('recentActivity').innerHTML = '<p class="text-muted">No recent activity yet. Students will appear here when they register and enroll in courses.</p>';
                } else {
                    const activityHtml = recentActivity.map(activity => `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <strong>${activity.text}</strong>
                            </div>
                            <small class="text-muted">${new Date(activity.date).toLocaleString()}</small>
                        </div>
                    `).join('');
                    document.getElementById('recentActivity').innerHTML = activityHtml;
                }
            } catch (error) {
                document.getElementById('recentActivity').innerHTML = '<p class="text-muted">No recent activity</p>';
            }
        }

        async function loadStudents() {
            try {
                console.log('Loading students from database...');
                const response = await fetch(`${getApiUrl()}/admin/students`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.status === 401) {
                    redirectToAdminLogin();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to load students');
                }
                
                const students = await response.json();
                console.log('Loaded students:', students);
                displayStudents(students);
            } catch (error) {
                console.error('Error loading students:', error);
                showToast('Error loading students data', 'error');
                document.getElementById('studentsTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading students. Please try again later.</td></tr>';
            }
        }

        function displayStudents(students) {
            const tableBody = document.getElementById('studentsTable');
            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No students found</td></tr>';
                return;
            }

            tableBody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.id}</td>
                    <td>${student.first_name} ${student.last_name}</td>
                    <td>${student.email}</td>
                    <td>${student.phone || 'N/A'}</td>
                    <td>${student.parent_phone || 'N/A'}</td>
                    <td>${new Date(student.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewStudentDetails(${student.id})">
                            <i class="bi bi-eye"></i> View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        let currentStudentPassword = '';
        
        async function viewStudentDetails(studentId) {
            try {
                // Fetch student details from database
                const response = await fetch(`${getApiUrl()}/admin/students`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const students = await response.json();
                const student = students.find(s => s.id === studentId);
                
                if (!student) {
                    alert('Student not found');
                    return;
                }
                
                // Populate student information
                document.getElementById('studentId').textContent = student.id;
                document.getElementById('studentFirstName').textContent = student.first_name || 'N/A';
                document.getElementById('studentLastName').textContent = student.last_name || 'N/A';
                document.getElementById('studentEmail').textContent = student.email || 'N/A';
                document.getElementById('studentPhone').textContent = student.phone || 'N/A';
                document.getElementById('studentParentPhone').textContent = student.parent_phone || 'N/A';
                document.getElementById('studentRole').textContent = student.role || 'student';
                document.getElementById('studentJoined').textContent = student.created_at ? new Date(student.created_at).toLocaleDateString() : 'N/A';
                document.getElementById('studentLastLogin').textContent = student.last_login ? new Date(student.last_login).toLocaleDateString() : 'Never';
                document.getElementById('studentUpdated').textContent = student.updated_at ? new Date(student.updated_at).toLocaleDateString() : 'N/A';
                document.getElementById('studentPoints').textContent = student.points || 0;
                
                const isActive = student.is_active !== undefined ? student.is_active : true;
                document.getElementById('studentStatus').innerHTML = isActive 
                    ? '<span class="badge bg-success">Active</span>' 
                    : '<span class="badge bg-danger">Inactive</span>';
                    
                document.getElementById('studentAccountStatus').innerHTML = isActive 
                    ? '<span class="badge bg-success">Active Account</span>' 
                    : '<span class="badge bg-danger">Inactive Account</span>';
                
                // Store password hash for copying
                currentStudentPassword = student.password || '';
                document.getElementById('studentPassword').textContent = student.password ? student.password.substring(0, 20) + '...' : 'N/A';
                
                // Populate activity and progress data
                document.getElementById('studentTotalPoints').textContent = student.points || 0;
                
                // Calculate days active (days since account creation)
                if (student.created_at) {
                    const createdDate = new Date(student.created_at);
                    const now = new Date();
                    const daysActive = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                    document.getElementById('studentDaysActive').textContent = daysActive;
                } else {
                    document.getElementById('studentDaysActive').textContent = 'N/A';
                }
                
                // Load enrollments
                loadStudentEnrollments(studentId);
                
                // Show modal
                new bootstrap.Modal(document.getElementById('studentDetailsModal')).show();
            } catch (error) {
                console.error('Error loading student details:', error);
                showToast('Failed to load student details', 'error');
            }
        }
        
                
        async function loadStudentEnrollments(studentId) {
            try {
                const response = await fetch(`${getApiUrl()}/admin/enrollments`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load enrollments');
                }
                
                const allEnrollments = await response.json();
                // Only show ACTIVE enrollments (filter out revoked/inactive ones)
                const studentEnrollments = allEnrollments.filter(e => e.user_id === studentId && e.status === 'active');
                
                // Update enrolled courses count
                document.getElementById('studentEnrolledCourses').textContent = studentEnrollments.length;
                
                const tbody = document.getElementById('studentEnrollments');
                
                if (studentEnrollments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No enrollments found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = studentEnrollments.map(enrollment => `
                    <tr>
                        <td>${enrollment.course_title}</td>
                        <td>${enrollment.instructor || 'N/A'}</td>
                        <td>${enrollment.price ? enrollment.price + ' EGP' : 'N/A'}</td>
                        <td>${new Date(enrollment.enrolled_at).toLocaleDateString()}</td>
                        <td><span class="badge bg-${enrollment.status === 'active' ? 'success' : 'secondary'}">${enrollment.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="revokeAccess(${enrollment.user_id}, ${enrollment.course_id})">
                                <i class="bi bi-x-circle"></i> Revoke
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading enrollments:', error);
                document.getElementById('studentEnrollments').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading enrollments</td></tr>';
            }
        }
        
                
                                        
                showToast('Course access granted successfully!', 'success');
                
                // Refresh the modal data
                loadStudentEnrollments(userId);
                
            } catch (error) {
                console.error('Error granting access:', error);
                showToast('Error granting access: ' + error.message, 'error');
            }
        }
        
                
        function copyPassword() {
            if (currentStudentPassword) {
                navigator.clipboard.writeText(currentStudentPassword);
                alert('Password hash copied to clipboard!');
            } else {
                alert('No password to copy');
            }
        }

        async function editStudent(studentId) {
            try {
                // Fetch student details
                const students = await apiCall('/api/admin/students');
                const student = students.find(s => s.id === studentId);
                
                if (!student) {
                    alert('Student not found!');
                    return;
                }

                // Create modal HTML
                const modalHtml = `
                    <div class="modal fade" id="editStudentModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit Student: ${student.first_name} ${student.last_name}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editStudentForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="editFirstName" class="form-label">First Name</label>
                                                    <input type="text" class="form-control" id="editFirstName" value="${student.first_name}" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="editLastName" class="form-label">Last Name</label>
                                                    <input type="text" class="form-control" id="editLastName" value="${student.last_name}" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="editEmail" value="${student.email}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editPhone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="editPhone" value="${student.phone || ''}">
                                        </div>
                                        <div class="mb-3">
                                            <label for="editRole" class="form-label">Role</label>
                                            <select class="form-select" id="editRole" required>
                                                <option value="student" ${student.role === 'student' ? 'selected' : ''}>Student</option>
                                                <option value="teacher" ${student.role === 'teacher' ? 'selected' : ''}>Teacher</option>
                                                <option value="admin" ${student.role === 'admin' ? 'selected' : ''}>Admin</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editStatus" class="form-label">Status</label>
                                            <select class="form-select" id="editStatus" required>
                                                <option value="1" ${student.is_active ? 'selected' : ''}>Active</option>
                                                <option value="0" ${!student.is_active ? 'selected' : ''}>Inactive</option>
                                            </select>
                                        </div>
                                        <div class="alert alert-info">
                                            <strong>Note:</strong> Student ID: ${student.id} | Created: ${new Date(student.created_at).toLocaleDateString()}
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="saveStudentChanges(${studentId})">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('editStudentModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading student details:', error);
                alert('Error loading student details: ' + error.message);
            }
        }

        async function saveStudentChanges(studentId) {
            try {
                const formData = {
                    first_name: document.getElementById('editFirstName').value,
                    last_name: document.getElementById('editLastName').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    role: document.getElementById('editRole').value,
                    is_active: document.getElementById('editStatus').value === '1'
                };

                const response = await fetch(`${getApiUrl()}/admin/update-student`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        studentId: studentId,
                        ...formData
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to update student');
                }

                const result = await response.json();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                modal.hide();
                
                // Show success message
                showToast('Student updated successfully!', 'success');
                
                // Refresh students table
                loadStudents();
                
            } catch (error) {
                console.error('Error updating student:', error);
                showToast('Error updating student: ' + error.message, 'error');
            }
        }

        async function removeStudent(studentId, studentName) {
            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to remove student "${studentName}"?\n\nThis action cannot be undone and will:\n- Delete the student's account\n- Remove all their progress data\n- Cancel any active enrollments\n\nType "DELETE" to confirm:`);
            
            if (!confirmed) {
                return;
            }
            
            // Additional confirmation with typing requirement
            const userInput = prompt(`To confirm deletion of student "${studentName}", please type "DELETE" (case sensitive):`);
            
            if (userInput !== "DELETE") {
                showToast('Student removal cancelled. You must type "DELETE" to confirm.', 'warning');
                return;
            }
            
            try {
                console.log(`Removing student ${studentId} (${studentName})...`);
                console.log('Auth token:', authToken ? 'Present' : 'Missing');
                
                const response = await fetch(`${getApiUrl()}/admin/remove-student`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ studentId })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}...`);
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to remove student');
                }

                const result = await response.json();
                
                // Show success message
                showToast(`Student "${studentName}" has been successfully removed!`, 'success');
                
                // Refresh students table
                loadStudents();
                
                // Refresh dashboard stats
                loadDashboard();
                
            } catch (error) {
                console.error('Error removing student:', error);
                showToast('Error removing student: ' + error.message, 'error');
            }
        }

        async function viewOrderDetails(orderId) {
            try {
                // Fetch detailed order information
                const order = await apiCall(`/api/admin/orders/${orderId}`);
                
                if (!order) {
                    alert('Order not found!');
                    return;
                }

                // Create modal HTML
                const modalHtml = `
                    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Order #${order.id} Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6>Student Information:</h6>
                                            <p><strong>Name:</strong> ${order.first_name} ${order.last_name}</p>
                                            <p><strong>User ID:</strong> ${order.user_id}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Order Information:</h6>
                                            <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                                            <p><strong>Status:</strong> <span class="badge ${order.status === 'completed' ? 'bg-success' : 'bg-warning'}">${order.status || 'pending'}</span></p>
                                            <p><strong>Payment Method:</strong> ${order.payment_method}</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="mb-3">
                                        <h6>Courses Purchased:</h6>
                                        <div id="orderCoursesList">
                                            ${order.items && order.items.length > 0 ? 
                                                order.items.map(item => 
                                                    `<div class="alert alert-info mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <i class="bi bi-book me-2"></i>
                                                                <strong>${item.title || 'Unknown Course'}</strong>
                                                                ${item.instructor ? `<br><small class="text-muted">Instructor: ${item.instructor}</small>` : ''}
                                                            </div>
                                                            <div class="text-end">
                                                                <span class="badge bg-primary">Qty: ${item.quantity || 1}</span>
                                                                <br><strong>${item.price} EGP</strong>
                                                            </div>
                                                        </div>
                                                    </div>`
                                                ).join('') : 
                                                '<div class="alert alert-warning">No courses found</div>'
                                            }
                                        </div>
                                    </div>
                                    <hr>
                                    <div>
                                        <h5>Total Amount: ${order.total_amount} EGP</h5>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    ${order.status !== 'completed' ? 
                                        `<button type="button" class="btn btn-success" onclick="approveOrder(${order.id})">
                                            <i class="bi bi-check-circle"></i> Approve & Grant Access
                                        </button>` : 
                                        '<span class="badge bg-success">Order Already Approved</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('orderDetailsModal');
                if (existingModal) existingModal.remove();

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                modal.show();

            } catch (error) {
                console.error('Error loading order details:', error);
                alert('Failed to load order details');
            }
        }

    // NOTE: the authoritative loadDashboard implementation is declared earlier (server-driven).
    // The duplicate sample-data-driven implementation was removed to avoid conflicts and "undefined" values.

        async function loadDashboard() {
            try {
                const [studentsRes, courses, enrollmentsData, ordersData] = await Promise.all([
                    apiCall('/api/admin/students'),
                    apiCall('/api/courses'),
                    apiCall('/api/admin/enrollments').catch(() => ({ enrollments: [] })),
                    apiCall('/api/admin/orders').catch(() => ({ orders: [] }))
                ]);
                
                // Extract arrays from response objects
                const enrollments = Array.isArray(enrollmentsData) ? enrollmentsData : (enrollmentsData.enrollments || []);
                const orders = Array.isArray(ordersData) ? ordersData : (ordersData.orders || []);
                
                const studentCount = Array.isArray(studentsRes) ? studentsRes.length : 0;
                document.getElementById('totalStudents').textContent = studentCount;
                document.getElementById('totalCourses').textContent = Array.isArray(courses) ? courses.length : 0;
                document.getElementById('totalEnrollments').textContent = enrollments.length;
                const revenue = orders.reduce((sum, order) => sum + (order.total_amount || 0), 0);
                document.getElementById('totalRevenue').textContent = revenue.toFixed(2) + ' EGP';
                loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('totalStudents').textContent = '0';
                document.getElementById('totalCourses').textContent = '0';
                document.getElementById('totalEnrollments').textContent = '0';
                document.getElementById('totalRevenue').textContent = '0.00 EGP';
            }
        }


        async function loadCourses() {
            try {
                const courses = await apiCall('/api/courses');
                
                const tableHtml = courses.map(course => `
                    <tr>
                        <td>${course.id}</td>
                        <td>${course.title}</td>
                        <td>${course.instructor}</td>
                        <td>${course.price} EGP</td>
                        <td>${course.level}</td>
                        <td>
                            <span class="badge ${course.is_active ? 'bg-success' : 'bg-danger'}">${course.is_active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('coursesTable').innerHTML = tableHtml;
            } catch (error) {
                document.getElementById('coursesTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading courses</td></tr>';
            }
        }

        async function loadEnrollments() {
            try {
                const enrollments = await apiCall('/api/admin/enrollments').catch(() => []);

                const tableHtml = enrollments.map(enrollment => {
                    const status = enrollment.status || (enrollment.is_active ? 'active' : 'inactive');
                    const userId = enrollment.user_id || enrollment.student_id || enrollment.studentId || enrollment.userId;
                    return `
                    <tr>
                        <td>${enrollment.first_name || enrollment.fname || ''} ${enrollment.last_name || enrollment.lname || ''}</td>
                        <td>${enrollment.course_title || enrollment.title || 'N/A'}</td>
                        <td>${enrollment.enrolled_at ? new Date(enrollment.enrolled_at).toLocaleDateString() : (enrollment.created_at ? new Date(enrollment.created_at).toLocaleDateString() : 'N/A')}</td>
                        <td>
                            <span class="badge ${status === 'active' ? 'bg-success' : 'bg-danger'}">${status}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="viewStudentDetails(${userId})">
                                <i class="bi bi-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEnrollment(${enrollment.id})">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>`;
                }).join('');

                document.getElementById('enrollmentsTable').innerHTML = tableHtml || `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="bi bi-info-circle me-2"></i>
                            No enrollments yet. Students will appear here when they are granted course access.
                        </td>
                    </tr>
                `;
            } catch (error) {
                document.getElementById('enrollmentsTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading enrollments</td></tr>';
            }
        }

    async function deleteEnrollment(enrollmentId) {
            if (!confirm('Are you sure you want to permanently delete this enrollment?')) {
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/admin/delete-enrollment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ enrollmentId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete enrollment');
                }

                showToast('Enrollment deleted successfully!', 'success');
                loadEnrollments();
            } catch (error) {
                console.error('Error deleting enrollment:', error);
                showToast('Error deleting enrollment: ' + error.message, 'error');
            }
        }

    async function loadOrders() {
            try {
                const response = await apiCall('/api/admin/orders');
                const orders = response.orders || response;
                
                const tableHtml = orders.map(order => {
                    const statusBadge = order.status === 'approved' ? 'bg-success' : order.status === 'pending' ? 'bg-warning' : 'bg-secondary';
                    const statusText = order.status || 'pending';
                    
                    // Parse courses to show details with enhanced formatting
                    let coursesInfo = 'N/A';
                    let coursesList = [];
                    
                    console.log(`Parsing courses for order #${order.id}:`, order.courses, typeof order.courses);
                    
                    try {
                        // First check if courses exist
                        if (!order.courses || order.courses === '' || order.courses === 'null' || order.courses === 'undefined') {
                            console.log(`Order #${order.id}: No courses data found`);
                            coursesInfo = '<span class="badge bg-secondary">No courses</span>';
                        } else {
                            // Try to parse as JSON
                            let courses = order.courses;
                            
                            // If it's a string, try to parse it
                            if (typeof courses === 'string') {
                                try {
                                    courses = JSON.parse(courses);
                                    console.log(`Order #${order.id}: Parsed courses as JSON:`, courses);
                                } catch (parseErr) {
                                    // If JSON parse fails, treat it as a plain string course name
                                    console.log(`Order #${order.id}: Treating as plain string:`, courses);
                                    coursesInfo = `<span class="badge bg-primary">${courses}</span>`;
                                    coursesList = [courses];
                                    
                                    // Skip further processing since we already have the display
                                    courses = null;
                                }
                            }
                            
                            // Now process the parsed courses
                            if (courses !== null) {
                                if (Array.isArray(courses)) {
                                    console.log(`Order #${order.id}: Processing array of courses:`, courses);
                                    
                                    coursesList = courses.map(c => {
                                        // Handle different course formats
                                        if (typeof c === 'string') {
                                            return c; // Direct string like "IGCSE English Language"
                                        } else if (typeof c === 'object' && c !== null) {
                                            return c.title || c.name || c.courseId || c.id || JSON.stringify(c);
                                        }
                                        return String(c);
                                    }).filter(c => c && c !== 'Unknown Course' && c !== '');
                                    
                                    console.log(`Order #${order.id}: Extracted course names:`, coursesList);
                                    
                                    // Create formatted display
                                    if (coursesList.length > 0) {
                                        coursesInfo = coursesList.map((course, idx) => 
                                            `<span class="badge bg-primary me-1 mb-1">${course}</span>`
                                        ).join('');
                                    } else {
                                        console.warn(`Order #${order.id}: Empty courses array!`);
                                        coursesInfo = '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> No courses saved</span>';
                                    }
                                } else if (typeof courses === 'object' && courses !== null) {
                                    // Single course object
                                    console.log(`Order #${order.id}: Processing single course object:`, courses);
                                    const courseName = courses.title || courses.name || courses.id || JSON.stringify(courses);
                                    coursesInfo = `<span class="badge bg-primary">${courseName}</span>`;
                                    coursesList = [courseName];
                                }
                            }
                        }
                    } catch (e) {
                        console.error(`Error parsing courses for order #${order.id}:`, e);
                        console.log(`Raw courses data for order #${order.id}:`, order.courses);
                        // If all parsing fails, show raw data in a safe way
                        if (order.courses) {
                            const rawDisplay = String(order.courses).substring(0, 100);
                            coursesInfo = `<span class="badge bg-warning text-dark">${rawDisplay}</span>`;
                        } else {
                            coursesInfo = '<span class="badge bg-secondary">No data</span>';
                        }
                    }
                    
                    return `
                        <tr>
                            <td><strong>#${order.id}</strong></td>
                            <td>
                                <div><strong>${order.customer_name || order.first_name + ' ' + order.last_name || 'N/A'}</strong></div>
                                <small class="text-muted"><i class="bi bi-envelope"></i> ${order.customer_email || order.email || 'N/A'}</small>
                                <br>
                                <small class="text-muted"><i class="bi bi-telephone"></i> ${order.customer_phone || order.phone || 'N/A'}</small>
                            </td>
                            <td>
                                <div>${coursesInfo}</div>
                                ${coursesList.length > 0 ? `<small class="text-muted">${coursesList.length} course${coursesList.length > 1 ? 's' : ''}</small>` : ''}
                            </td>
                            <td><strong>${parseFloat(order.total_amount).toFixed(2)} EGP</strong></td>
                            <td>
                                <span class="badge bg-info">${order.payment_method || 'N/A'}</span>
                            </td>
                            <td>
                                <span class="badge ${statusBadge}">${statusText}</span>
                            </td>
                            <td><small>${new Date(order.created_at).toLocaleDateString()}</small></td>
                            <td>
                                ${order.status === 'pending' ? `
                                    <button class="btn btn-sm btn-success me-1" onclick="grantCourseAccess(${order.id})" title="Approve and grant access">
                                        <i class="bi bi-check-circle"></i> Grant Access
                                    </button>
                                ` : `
                                    <span class="text-success"><i class="bi bi-check-circle-fill"></i> Approved</span>
                                `}
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder(${order.id})" title="Delete order">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="viewOrderDetails(${order.id})" title="View details">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('ordersTable').innerHTML = tableHtml || `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="bi bi-info-circle me-2"></i>
                            No orders yet. Orders will appear here when students purchase courses.
                        </td>
                    </tr>
                `;
            } catch (error) {
                document.getElementById('ordersTable').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading orders</td></tr>';
            }
        }

        async function grantCourseAccess(orderId) {
            if (!confirm('Grant access to the student for all courses in this order? The student will be able to access their courses immediately.')) {
                return;
            }

            try {
                showToast('Processing order...', 'info');
                
                const response = await fetch(`${getApiUrl()}/admin/approve-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ order_id: orderId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to approve order');
                }

                showToast(`Order approved! ${data.enrollmentsCreated || 0} enrollment(s) created.`, 'success');
                
                // Reload orders to show updated status
                await loadOrders();
                
            } catch (error) {
                console.error('Error approving order:', error);
                showToast('Error approving order: ' + error.message, 'error');
            }
        }

        async function viewOrderDetails(orderId) {
            try {
                const response = await apiCall('/api/admin/orders');
                const orders = response.orders || response;
                const order = orders.find(o => o.id === orderId);
                
                if (!order) {
                    showToast('Order not found', 'error');
                    return;
                }
                
                // Parse courses
                let coursesHtml = 'N/A';
                try {
                    let courses = typeof order.courses === 'string' ? JSON.parse(order.courses) : order.courses;
                    if (Array.isArray(courses)) {
                        coursesHtml = courses.map(c => {
                            const courseName = typeof c === 'string' ? c : (c.title || c.name || 'Unknown');
                            return `<li class="list-group-item"><i class="bi bi-book"></i> ${courseName}</li>`;
                        }).join('');
                    } else if (typeof courses === 'string') {
                        coursesHtml = `<li class="list-group-item"><i class="bi bi-book"></i> ${courses}</li>`;
                    }
                } catch (e) {
                    coursesHtml = `<li class="list-group-item text-muted">${order.courses}</li>`;
                }
                
                // Create modal
                const modalHtml = `
                    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Order Details #${order.id}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Customer Information</h6>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item"><strong>Name:</strong> ${order.customer_name || 'N/A'}</li>
                                                <li class="list-group-item"><strong>Email:</strong> ${order.customer_email || 'N/A'}</li>
                                                <li class="list-group-item"><strong>Phone:</strong> ${order.customer_phone || 'N/A'}</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Order Information</h6>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item"><strong>Order ID:</strong> #${order.id}</li>
                                                <li class="list-group-item"><strong>Total Amount:</strong> ${parseFloat(order.total_amount).toFixed(2)} EGP</li>
                                                <li class="list-group-item"><strong>Payment Method:</strong> ${order.payment_method || 'N/A'}</li>
                                                <li class="list-group-item"><strong>Status:</strong> <span class="badge ${order.status === 'approved' ? 'bg-success' : 'bg-warning'}">${order.status || 'pending'}</span></li>
                                                <li class="list-group-item"><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <h6>Purchased Courses</h6>
                                            <ul class="list-group">
                                                ${coursesHtml}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    ${order.status === 'pending' ? `
                                        <button type="button" class="btn btn-success" onclick="grantCourseAccess(${order.id}); bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal')).hide();">
                                            <i class="bi bi-check-circle"></i> Grant Access
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('orderDetailsModal');
                if (existingModal) existingModal.remove();
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error viewing order details:', error);
                showToast('Error loading order details: ' + error.message, 'error');
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to permanently delete this order and all related items?')) {
                return;
            }

            try {
                console.log('ðŸ—‘ï¸ Deleting order:', orderId);
                const response = await fetch(`${getApiUrl()}/admin/delete-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ order_id: orderId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete order');
                }

                showToast('Order deleted successfully!', 'success');
                loadOrders();
            } catch (error) {
                console.error('Error deleting order:', error);
                showToast('Error deleting order: ' + error.message, 'error');
            }
        }

    async function searchStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            
            try {
                const response = await fetch(`${getApiUrl()}/admin/students`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const students = await response.json();
                
                const filteredStudents = students.filter(student => 
                    student.first_name.toLowerCase().includes(searchTerm) || 
                    student.last_name.toLowerCase().includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm)
                );
                
                displayStudents(filteredStudents);
            } catch (error) {
                console.error('Error searching students:', error);
            }
        }

        // Authentication Functions
    async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                // Call backend API to login and get JWT token
                const response = await fetch(`${getApiUrl()}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.token) {
                    // Store auth token
                    authToken = data.token;
                    localStorage.setItem('adminToken', data.token);
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminEmail', email);
                    
                    console.log('âœ… Admin logged in successfully');
                    console.log('Token:', authToken.substring(0, 20) + '...');
                    
                    // Show success toast
                    showToast('Login successful! Welcome to the admin panel.', 'success');
                    
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if (loginModal) {
                        loginModal.hide();
                    }
                    
                    document.getElementById('mainContent').style.display = 'block';
                    initializeAdminPanel();
                } else {
                    errorDiv.textContent = data.error || 'Invalid email or password';
                    errorDiv.style.display = 'block';
                    showToast('Login failed. Please check your credentials.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Login failed. Please check your credentials.';
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminEmail');
            localStorage.removeItem('adminToken');
            authToken = null;
            window.location.replace('admin-login.html');
        }

        function checkAuth() {
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                authToken = savedToken;
                testAdminToken(savedToken);
            } else {
                redirectToAdminLogin();
            }
        }

        async function testAdminToken(token) {
            try {
                const response = await fetch(`${getApiUrl()}/admin/students`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    authToken = token;
                    document.getElementById('mainContent').style.display = 'block';
                    initializeAdminPanel();
                } else {
                    redirectToAdminLogin();
                }
            } catch (error) {
                redirectToAdminLogin();
            }
        }

        function initializeAdminPanel() {
            loadDashboard();
            showSection('dashboard');
        }

        // Data Management Functions
        function getStudents() {
            return JSON.parse(localStorage.getItem('adminStudents') || '[]');
        }

        function saveStudents(students) {
            localStorage.setItem('adminStudents', JSON.stringify(students));
        }

        function getCourses() {
            return JSON.parse(localStorage.getItem('adminCourses') || '[]');
        }

        function saveCourses(courses) {
            localStorage.setItem('adminCourses', JSON.stringify(courses));
        }

        function getEnrollments() {
            return JSON.parse(localStorage.getItem('adminEnrollments') || '[]');
        }

        function saveEnrollments(enrollments) {
            localStorage.setItem('adminEnrollments', JSON.stringify(enrollments));
        }

        function getOrders() {
            return JSON.parse(localStorage.getItem('adminOrders') || '[]');
        }

        function saveOrders(orders) {
            localStorage.setItem('adminOrders', JSON.stringify(orders));
        }

        // Initialize sample data if none exists
        function initializeSampleData() {
            if (getStudents().length === 0) {
                const sampleStudents = [
                    { id: 1, name: 'John Smith', email: 'john@example.com', phone: '+44 7123 456789', joined: '2024-01-15', status: 'active' },
                    { id: 2, name: 'Sarah Johnson', email: 'sarah@example.com', phone: '+44 7234 567890', joined: '2024-01-20', status: 'active' },
                    { id: 3, name: 'Mike Brown', email: 'mike@example.com', phone: '+44 7345 678901', joined: '2024-02-01', status: 'active' },
                    { id: 4, name: 'Emma Wilson', email: 'emma@example.com', phone: '+44 7456 789012', joined: '2024-02-10', status: 'inactive' }
                ];
                saveStudents(sampleStudents);
            }

            if (getCourses().length === 0) {
                const sampleCourses = [
                    { id: 1, name: 'Mathematics IGCSE', instructor: 'Dr. Smith', price: 299, students: 45, status: 'active' },
                    { id: 2, name: 'Mathematics Advanced', instructor: 'Prof. Johnson', price: 399, students: 32, status: 'active' },
                    { id: 3, name: 'Mathematics Foundation', instructor: 'Dr. Brown', price: 199, students: 28, status: 'active' }
                ];
                saveCourses(sampleCourses);
            }

            if (getEnrollments().length === 0) {
                const sampleEnrollments = [
                    { id: 1, studentId: 1, courseId: 1, enrolledDate: '2024-01-16', status: 'active' },
                    { id: 2, studentId: 1, courseId: 2, enrolledDate: '2024-01-16', status: 'active' },
                    { id: 3, studentId: 2, courseId: 1, enrolledDate: '2024-01-21', status: 'active' },
                    { id: 4, studentId: 3, courseId: 3, enrolledDate: '2024-02-02', status: 'active' }
                ];
                saveEnrollments(sampleEnrollments);
            }

            if (getOrders().length === 0) {
                const sampleOrders = [
                    { id: 1, studentId: 1, courseId: 1, amount: 299, status: 'completed', created_at: '2024-01-15' },
                    { id: 2, studentId: 1, courseId: 2, amount: 299, status: 'completed', created_at: '2024-01-15' },
                    { id: 3, studentId: 2, courseId: 1, amount: 299, status: 'completed', created_at: '2024-01-20' },
                    { id: 4, studentId: 3, courseId: 3, amount: 299, status: 'pending', created_at: '2024-02-01' }
                ];
                saveOrders(sampleOrders);
            }
        }

        // Teacher Management Functions
        let currentTeacherId = null;

        async function loadTeachers() {
            try {
                const teachers = await apiCall('/api/admin/teachers').catch(() => []);
                displayTeachers(teachers);
                return;
            } catch (error) {
                console.error('Error loading teachers:', error);
                document.getElementById('teachersTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading teachers</td></tr>';
            }
        }

        function displayTeachers(teachers) {
            const tableBody = document.getElementById('teachersTable');
            if (teachers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No teachers found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = teachers.map(teacher => `
                <tr>
                    <td>${teacher.name || teacher.full_name || `${teacher.first_name || ''} ${teacher.last_name || ''}`.trim() || teacher.email || 'N/A'}</td>
                    <td>${teacher.email}</td>
                    <td><span class="badge bg-primary">${teacher.subject || 'N/A'}</span></td>
                    <td>${teacher.experience || 0} years</td>
                    <td>
                        <span class="badge bg-info">${teacher.assistants_count || 0} assistants</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewTeacherDetails(${teacher.id})">
                            <i class="bi bi-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTeacher(${teacher.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddTeacherModal() {
            const modal = new bootstrap.Modal(document.getElementById('addTeacherModal'));
            modal.show();
        }

        async function addTeacher() {
            const name = document.getElementById('teacherName').value;
            const email = document.getElementById('teacherEmail').value;
            const subject = document.getElementById('teacherSubject').value;
            const experience = document.getElementById('teacherExperience').value;
            const phone = document.getElementById('teacherPhone').value;

            if (!name || !email || !subject || !experience) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/admin/teachers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        email,
                        subject,
                        experience: parseInt(experience),
                        phone
                    })
                });

                if (response.ok) {
                    showToast('Teacher added successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addTeacherModal')).hide();
                    document.getElementById('addTeacherForm').reset();
                    loadTeachers();
                } else {
                    const error = await response.json();
                    showToast('Error adding teacher: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Error adding teacher:', error);
                showToast('Error adding teacher', 'error');
            }
        }

        async function viewTeacherDetails(teacherId) {
            currentTeacherId = teacherId;
            try {
                const teacher = await apiCall(`/api/admin/teachers/${teacherId}`).catch(() => null);
                if (!teacher) throw new Error('Failed to load teacher details');
                
                // Populate teacher details
                document.getElementById('teacherDetailName').textContent = teacher.name || teacher.full_name || `${teacher.first_name || ''} ${teacher.last_name || ''}`.trim() || teacher.email || 'N/A';
                document.getElementById('teacherDetailEmail').textContent = teacher.email;
                document.getElementById('teacherDetailSubject').textContent = teacher.subject || 'N/A';
                document.getElementById('teacherDetailExperience').textContent = teacher.experience;
                document.getElementById('teacherDetailPhone').textContent = teacher.phone || 'N/A';
                
                // Load assistants
                loadTeacherAssistants(teacherId);
                
                const modal = new bootstrap.Modal(document.getElementById('teacherDetailsModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading teacher details:', error);
                showToast('Error loading teacher details', 'error');
            }
        }

        async function loadTeacherAssistants(teacherId) {
            try {
                const assistants = await apiCall(`/api/admin/teachers/${teacherId}/assistants`).catch(() => []);
                const assistantsList = document.getElementById('assistantsList');
                
                if (assistants.length === 0) {
                    assistantsList.innerHTML = '<p class="text-muted">No assistants assigned</p>';
                    return;
                }
                
                assistantsList.innerHTML = assistants.map(assistant => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${assistant.name}</strong><br>
                            <small class="text-muted">${assistant.email} â€¢ ${assistant.role}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeAssistant(${assistant.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading assistants:', error);
                document.getElementById('assistantsList').innerHTML = '<p class="text-danger">Error loading assistants</p>';
            }
        }

        function showAddAssistantModal() {
            if (!currentTeacherId) {
                alert('No teacher selected');
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('addAssistantModal'));
            modal.show();
        }

        async function addAssistant() {
            const name = document.getElementById('assistantName').value;
            const email = document.getElementById('assistantEmail').value;
            const phone = document.getElementById('assistantPhone').value;
            const role = document.getElementById('assistantRole').value;

            if (!name || !email || !role) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/admin/teachers/${currentTeacherId}/assistants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        email,
                        phone,
                        role
                    })
                });

                if (response.ok) {
                    showToast('Assistant added successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addAssistantModal')).hide();
                    document.getElementById('addAssistantForm').reset();
                    loadTeacherAssistants(currentTeacherId);
                } else {
                    const error = await response.json();
                    showToast('Error adding assistant: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Error adding assistant:', error);
                showToast('Error adding assistant', 'error');
            }
        }

        async function removeAssistant(assistantId) {
            if (!confirm('Are you sure you want to remove this assistant?')) {
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/admin/assistants/${assistantId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showToast('Assistant removed successfully!', 'success');
                    loadTeacherAssistants(currentTeacherId);
                } else {
                    const error = await response.json();
                    showToast('Error removing assistant: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Error removing assistant:', error);
                showToast('Error removing assistant', 'error');
            }
        }

        async function deleteTeacher(teacherId) {
            if (!confirm('Are you sure you want to delete this teacher? This will also remove all their assistants.')) {
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/admin/teachers/${teacherId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showToast('Teacher deleted successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('teacherDetailsModal')).hide();
                    loadTeachers();
                } else {
                    const error = await response.json();
                    showToast('Error deleting teacher: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting teacher:', error);
                showToast('Error deleting teacher', 'error');
            }
        }

        // Parent Management Functions
        let currentParentId = null;
        let allParents = [];
        let filteredParents = [];

        async function loadParents() {
            try {
                console.log('Loading parents from database...');
                const response = await fetch(`${getApiUrl()}/admin/parents`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allParents = await response.json();
                filteredParents = [...allParents];
                displayParents(filteredParents);
                
                console.log(`Loaded ${allParents.length} parents`);
            } catch (error) {
                console.error('Error loading parents:', error);
                document.getElementById('parentsTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                            <p class="mt-2">Error loading parents: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function displayParents(parents) {
            const tbody = document.getElementById('parentsTableBody');
            
            if (parents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-people-fill fs-1"></i>
                            <p class="mt-2">No parents found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = parents.map(parent => `
                <tr>
                    <td>${parent.id}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px;">
                                ${parent.first_name ? parent.first_name.charAt(0).toUpperCase() : 'P'}
                            </div>
                            <div>
                                <strong>${parent.first_name || ''} ${parent.last_name || ''}</strong>
                            </div>
                        </div>
                    </td>
                    <td>${parent.email || 'N/A'}</td>
                    <td>${parent.phone || '—'}</td>
                    <td>${parent.children_names || '—'}</td>
                    <td>${parent.created_at ? new Date(parent.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td>${parent.last_login ? new Date(parent.last_login).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <span class="badge ${parent.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                            ${parent.status || 'inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewParent(${parent.id})" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="editParent(${parent.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteParent(${parent.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterParents() {
            const searchTerm = document.getElementById('parentSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('parentStatusFilter').value;
            
            filteredParents = allParents.filter(parent => {
                const matchesSearch = !searchTerm || 
                    (parent.first_name && parent.first_name.toLowerCase().includes(searchTerm)) ||
                    (parent.last_name && parent.last_name.toLowerCase().includes(searchTerm)) ||
                    (parent.email && parent.email.toLowerCase().includes(searchTerm)) ||
                    (parent.phone && parent.phone.includes(searchTerm));
                
                const matchesStatus = !statusFilter || parent.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            displayParents(filteredParents);
        }

        function sortParents() {
            const sortBy = document.getElementById('parentSortBy').value;
            
            filteredParents.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        const nameA = `${a.first_name || ''} ${a.last_name || ''}`.toLowerCase();
                        const nameB = `${b.first_name || ''} ${b.last_name || ''}`.toLowerCase();
                        return nameA.localeCompare(nameB);
                    case 'email':
                        return (a.email || '').localeCompare(b.email || '');
                    case 'created_at':
                        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                    case 'last_login':
                        return new Date(b.last_login || 0) - new Date(a.last_login || 0);
                    default:
                        return 0;
                }
            });
            
            displayParents(filteredParents);
        }

        async function viewParent(parentId) {
            try {
                const response = await fetch(`${getApiUrl()}/admin/parents/${parentId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const parent = await response.json();
                
                // Create and show parent details modal
                showParentDetailsModal(parent);
                
            } catch (error) {
                console.error('Error loading parent details:', error);
                alert('Error loading parent details: ' + error.message);
            }
        }

        function showParentDetailsModal(parent) {
            const modalHtml = `
                <div class="modal fade" id="parentDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Parent Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Personal Information</h6>
                                        <p><strong>Name:</strong> ${parent.first_name || ''} ${parent.last_name || ''}</p>
                                        <p><strong>Email:</strong> ${parent.email || 'N/A'}</p>
                                        <p><strong>Phone:</strong> ${parent.phone || 'N/A'}</p>
                                        <p><strong>Status:</strong> 
                                            <span class="badge ${parent.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                                ${parent.status || 'inactive'}
                                            </span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Account Information</h6>
                                        <p><strong>Registration Date:</strong> ${parent.created_at ? new Date(parent.created_at).toLocaleDateString() : 'N/A'}</p>
                                        <p><strong>Last Login:</strong> ${parent.last_login ? new Date(parent.last_login).toLocaleDateString() : 'Never'}</p>
                                        <p><strong>Children Count:</strong> ${parent.children_count || 0}</p>
                                    </div>
                                </div>
                                
                                ${parent.children && parent.children.length > 0 ? `
                                    <hr>
                                    <h6 class="text-primary">Children</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Grade</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${parent.children.map(child => `
                                                    <tr>
                                                        <td>${child.first_name || ''} ${child.last_name || ''}</td>
                                                        <td>${child.email || 'N/A'}</td>
                                                        <td>${child.grade || 'N/A'}</td>
                                                        <td>
                                                            <span class="badge ${child.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                                                ${child.status || 'inactive'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="editParent(${parent.id})">Edit Parent</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('parentDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('parentDetailsModal'));
            modal.show();
        }

        async function editParent(parentId) {
            // Close details modal if open
            const detailsModal = document.getElementById('parentDetailsModal');
            if (detailsModal) {
                const modal = bootstrap.Modal.getInstance(detailsModal);
                if (modal) modal.hide();
            }
            
            // For now, just show an alert - you can implement edit functionality later
            alert('Edit parent functionality will be implemented soon!');
        }

        async function deleteParent(parentId) {
            if (!confirm('Are you sure you want to delete this parent? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/admin/parents/${parentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                alert('Parent deleted successfully!');
                loadParents(); // Refresh the list
                
            } catch (error) {
                console.error('Error deleting parent:', error);
                alert('Error deleting parent: ' + error.message);
            }
        }

        async function exportParents() {
            try {
                const response = await fetch(`${getApiUrl()}/admin/parents/export`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `parents_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Error exporting parents:', error);
                alert('Error exporting parents: ' + error.message);
            }
        }

        // Assistant Management Functions

        // Course Analytics Functions
        let courseAnalyticsData = {
            courses: [],
            students: [],
            enrollments: [],
            leaderboard: []
        };

        async function loadCourseAnalytics() {
            try {
                console.log('Loading course analytics...');
                console.log('Auth token present:', !!authToken);
                
                // Load courses, students, and enrollments
                const [courses, students, enrollments] = await Promise.all([
                    apiCall('/api/courses').catch(err => {
                        console.error('Error loading courses:', err);
                        return [];
                    }),
                    apiCall('/api/admin/students').catch(err => {
                        console.error('Error loading students:', err);
                        return [];
                    }),
                    apiCall('/api/admin/enrollments').catch(err => {
                        console.error('Error loading enrollments:', err);
                        return [];
                    })
                ]);

                console.log('Course analytics data loaded:', { 
                    courses: courses.length, 
                    students: students.length, 
                    enrollments: enrollments.length 
                });

                courseAnalyticsData = { courses, students, enrollments };

                // Populate course dropdown
                populateCourseDropdown(courses);
                
                // Update overview stats
                updateOverviewStats(courses, enrollments, students);
                
                // Display students per course
                displayStudentsPerCourse(courses, enrollments, students);
                
                // Load leaderboard for selected course
                const selectedCourseId = document.getElementById('courseSelect').value;
                if (selectedCourseId) {
                    await loadCourseLeaderboard(selectedCourseId);
                }
            } catch (error) {
                console.error('Error loading course analytics:', error);
                showToast('Error loading course analytics data: ' + error.message, 'error');
            }
        }

        function populateCourseDropdown(courses) {
            console.log('Populating course dropdown with courses:', courses);
            const courseSelect = document.getElementById('courseSelect');
            
            if (!courseSelect) {
                console.error('courseSelect element not found');
                return;
            }
            
            courseSelect.innerHTML = '<option value="">Select a course...</option>';
            
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.title || course.name} (${course.subject || 'General'})`;
                courseSelect.appendChild(option);
                console.log('Added course option:', course.title || course.name);
            });
            
            console.log('Course dropdown populated with', courses.length, 'courses');
        }

        function updateOverviewStats(courses, enrollments, students) {
            console.log('Updating overview stats:', { courses: courses.length, enrollments: enrollments.length, students: students.length });
            
            try {
                // Total courses
                const totalCoursesEl = document.getElementById('analyticsTotalCourses');
                if (totalCoursesEl) {
                    totalCoursesEl.textContent = courses.length;
                    console.log('Updated total courses:', courses.length);
                } else {
                    console.error('analyticsTotalCourses element not found');
                }
                
                // Total enrollments
                const totalEnrollmentsEl = document.getElementById('analyticsTotalEnrollments');
                if (totalEnrollmentsEl) {
                    totalEnrollmentsEl.textContent = enrollments.length;
                    console.log('Updated total enrollments:', enrollments.length);
                } else {
                    console.error('analyticsTotalEnrollments element not found');
                }
                
                // Top performer (student with highest points)
                const topStudent = students.reduce((max, student) => 
                    (student.points || 0) > (max.points || 0) ? student : max, 
                    { first_name: 'N/A', last_name: '', points: 0 }
                );
                const topPerformerEl = document.getElementById('analyticsTopPerformer');
                if (topPerformerEl) {
                    const topPerformerName = topStudent.first_name && topStudent.last_name 
                        ? `${topStudent.first_name} ${topStudent.last_name}` 
                        : topStudent.first_name || 'N/A';
                    topPerformerEl.textContent = topPerformerName;
                    console.log('Updated top performer:', topPerformerName);
                } else {
                    console.error('analyticsTopPerformer element not found');
                }
                
                // Average points
                const totalPoints = students.reduce((sum, student) => sum + (student.points || 0), 0);
                const avgPoints = students.length > 0 ? Math.round(totalPoints / students.length) : 0;
                const avgPointsEl = document.getElementById('analyticsAvgPoints');
                if (avgPointsEl) {
                    avgPointsEl.textContent = avgPoints;
                    console.log('Updated avg points:', avgPoints);
                } else {
                    console.error('analyticsAvgPoints element not found');
                }
            } catch (error) {
                console.error('Error updating overview stats:', error);
            }
        }

        function displayStudentsPerCourse(courses, enrollments, students) {
            console.log('Displaying students per course');
            const container = document.getElementById('studentsPerCourseCards');
            
            if (!container) {
                console.error('studentsPerCourseCards element not found');
                return;
            }
            
            // Count students per course and track which students
            const courseData = {};
            
            enrollments.forEach(enrollment => {
                const courseId = enrollment.course_id;
                if (!courseData[courseId]) {
                    courseData[courseId] = {
                        count: 0,
                        students: []
                    };
                }
                
                // Find the student for this enrollment
                const student = students.find(s => s.id === enrollment.student_id || s.id === enrollment.user_id);
                if (student) {
                    courseData[courseId].count++;
                    courseData[courseId].students.push(student);
                }
            });
            
            // Calculate total enrollments for percentage
            const totalEnrollments = enrollments.length || 1;
            
            // Create cards for each course
            const cardsHtml = courses.map(course => {
                const data = courseData[course.id] || { count: 0, students: [] };
                const studentCount = data.count;
                const percentage = Math.round((studentCount / totalEnrollments) * 100);
                
                // Determine color based on enrollment
                let colorClass = 'info';
                if (studentCount === 0) colorClass = 'secondary';
                else if (studentCount < 5) colorClass = 'warning';
                else if (studentCount < 10) colorClass = 'primary';
                else colorClass = 'success';
                
                return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-${colorClass}" style="cursor: pointer;" onclick="showCourseStudents(${course.id}, '${(course.title || course.subject || 'Course').replace(/'/g, "\\'")}')">
                            <div class="card-body">
                                <h6 class="card-title text-${colorClass}">
                                    <i class="bi bi-book me-2"></i>${course.title || course.subject || 'Course'}
                                </h6>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        <div class="h3 mb-0 text-${colorClass}">${studentCount}</div>
                                        <small class="text-muted">Students</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="badge bg-${colorClass}">${percentage}%</div>
                                        <small class="d-block text-muted">of enrollments</small>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 8px;">
                                    <div class="progress-bar bg-${colorClass}" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="mt-2 d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-person-check me-1"></i>Level: ${course.level || 'N/A'}
                                    </small>
                                    ${studentCount > 0 ? '<small class="text-primary"><i class="bi bi-eye me-1"></i>Click to view</small>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = cardsHtml || '<div class="col-12 text-center text-muted"><p>No courses found</p></div>';
        }
        
        function showCourseStudents(courseId, courseName) {
            console.log('Showing students for course:', courseId, courseName);
            
            if (!courseAnalyticsData) {
                showToast('Course data not loaded', 'error');
                return;
            }
            
            // Get enrollments for this course
            const courseEnrollments = courseAnalyticsData.enrollments.filter(e => e.course_id === courseId);
            
            if (courseEnrollments.length === 0) {
                showToast('No students enrolled in this course', 'info');
                return;
            }
            
            // Get student details
            const enrolledStudents = courseEnrollments.map(enrollment => {
                const student = courseAnalyticsData.students.find(s => 
                    s.id === enrollment.student_id || s.id === enrollment.user_id
                );
                return {
                    ...student,
                    enrolledAt: enrollment.enrolled_at,
                    points: student?.points || 0
                };
            }).filter(s => s.id); // Filter out null students
            
            // Sort by points descending
            enrolledStudents.sort((a, b) => (b.points || 0) - (a.points || 0));
            
            // Create modal content
            const studentsHtml = enrolledStudents.map((student, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${student.first_name} ${student.last_name}</td>
                    <td>${student.email}</td>
                    <td><span class="badge bg-success">${student.points || 0} pts</span></td>
                    <td>${new Date(student.enrolledAt).toLocaleDateString()}</td>
                </tr>
            `).join('');
            
            // Create and show modal
            const modalHtml = `
                <div class="modal fade" id="courseStudentsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-people me-2"></i>${courseName} - Enrolled Students</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Points</th>
                                                <th>Enrolled</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${studentsHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('courseStudentsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('courseStudentsModal'));
            modal.show();
            
            // Cleanup on close
            document.getElementById('courseStudentsModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        async function loadCourseLeaderboard(courseId) {
            try {
                if (!courseId) {
                    // Clear the leaderboard if no course selected
                    document.getElementById('leaderboardTable').innerHTML = '<tr><td colspan="6" class="text-center">Select a course to view leaderboard</td></tr>';
                    document.getElementById('courseInfo').style.display = 'none';
                    return;
                }

                // Get course info
                const course = courseAnalyticsData.courses.find(c => c.id == courseId);
                if (!course) {
                    console.error('Course not found:', courseId);
                    return;
                }

                // Show course info
                document.getElementById('selectedCourseName').textContent = course.title || course.name;
                document.getElementById('courseStudentCount').textContent = courseAnalyticsData.enrollments.filter(e => e.course_id == courseId).length;
                document.getElementById('courseDuration').textContent = course.duration || 'N/A';
                document.getElementById('courseLevel').textContent = course.level || 'N/A';
                document.getElementById('courseInfo').style.display = 'block';

                // Get students enrolled in this course
                const courseEnrollments = courseAnalyticsData.enrollments.filter(e => e.course_id == courseId);
                const enrolledStudentIds = courseEnrollments.map(e => e.student_id);
                const enrolledStudents = courseAnalyticsData.students.filter(s => enrolledStudentIds.includes(s.id));

                // Sort students by points (descending)
                const leaderboard = enrolledStudents
                    .map(student => ({
                        ...student,
                        progress: Math.min(100, Math.round((student.points || 0) / 10)), // Simple progress calculation
                        lastActivity: student.last_login || 'Never'
                    }))
                    .sort((a, b) => (b.points || 0) - (a.points || 0));

                courseAnalyticsData.leaderboard = leaderboard;
                displayLeaderboard(leaderboard);
                
                // Update charts
                updateCharts(course, leaderboard);
            } catch (error) {
                console.error('Error loading course leaderboard:', error);
                showToast('Error loading course leaderboard', 'error');
            }
        }

        function displayLeaderboard(leaderboard) {
            const tbody = document.getElementById('leaderboardTable');
            tbody.innerHTML = '';

            if (leaderboard.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No students enrolled in this course</td></tr>';
                return;
            }

            leaderboard.forEach((student, index) => {
                const row = document.createElement('tr');
                const rank = index + 1;
                const rankIcon = rank === 1 ? 'ðŸ¥‡' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : `#${rank}`;
                
                row.innerHTML = `
                    <td>
                        <span class="badge ${rank <= 3 ? 'bg-warning' : 'bg-secondary'}">${rankIcon}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                ${(student.first_name || student.name || 'S').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="fw-bold">${student.first_name && student.last_name ? `${student.first_name} ${student.last_name}` : student.name || 'Unknown'}</div>
                                <small class="text-muted">${student.email}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-success fs-6">${student.points || 0}</span>
                    </td>
                    <td>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" style="width: ${student.progress}%"></div>
                        </div>
                        <small class="text-muted">${student.progress}%</small>
                    </td>
                    <td>
                        <small class="text-muted">${student.lastActivity}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewStudentDetailsFromAnalytics(${student.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="awardPoints(${student.id})">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCharts(course, leaderboard) {
            // Course Performance Chart (simple bar chart)
            const performanceCtx = document.getElementById('coursePerformanceChart').getContext('2d');
            const performanceData = {
                labels: ['Completed', 'In Progress', 'Not Started'],
                datasets: [{
                    label: 'Students',
                    data: [
                        leaderboard.filter(s => s.progress === 100).length,
                        leaderboard.filter(s => s.progress > 0 && s.progress < 100).length,
                        leaderboard.filter(s => s.progress === 0).length
                    ],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                }]
            };

            // Points Distribution Chart (simple pie chart)
            const pointsCtx = document.getElementById('pointsDistributionChart').getContext('2d');
            const pointsData = {
                labels: ['0-25', '26-50', '51-75', '76-100'],
                datasets: [{
                    data: [
                        leaderboard.filter(s => (s.points || 0) <= 25).length,
                        leaderboard.filter(s => (s.points || 0) > 25 && (s.points || 0) <= 50).length,
                        leaderboard.filter(s => (s.points || 0) > 50 && (s.points || 0) <= 75).length,
                        leaderboard.filter(s => (s.points || 0) > 75).length
                    ],
                    backgroundColor: ['#dc3545', '#ffc107', '#17a2b8', '#28a745']
                }]
            };

            // Simple chart rendering (you can replace with Chart.js for better charts)
            renderSimpleChart(performanceCtx, performanceData, 'bar');
            renderSimpleChart(pointsCtx, pointsData, 'pie');
        }

        function renderSimpleChart(ctx, data, type) {
            // Simple chart rendering - in production, use Chart.js or similar
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            ctx.fillStyle = '#6c757d';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Chart visualization would go here', ctx.canvas.width/2, ctx.canvas.height/2);
            ctx.fillText(`Data: ${data.datasets[0].data.join(', ')}`, ctx.canvas.width/2, ctx.canvas.height/2 + 20);
        }

        function refreshLeaderboard() {
            const selectedCourseId = document.getElementById('courseSelect').value;
            if (selectedCourseId) {
                loadCourseLeaderboard(selectedCourseId);
            } else {
                alert('Please select a course first');
            }
        }

        function exportLeaderboard() {
            const selectedCourseId = document.getElementById('courseSelect').value;
            if (!selectedCourseId) {
                alert('Please select a course first');
                return;
            }

            const course = courseAnalyticsData.courses.find(c => c.id == selectedCourseId);
            const leaderboard = courseAnalyticsData.leaderboard;

            // Create CSV content
            let csv = 'Rank,Student Name,Email,Points,Progress,Last Activity\n';
            leaderboard.forEach((student, index) => {
                csv += `${index + 1},"${student.name}","${student.email}",${student.points || 0},${student.progress}%,"${student.lastActivity}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${course.name}_leaderboard.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function viewStudentDetailsFromAnalytics(studentId) {
            const student = courseAnalyticsData.students.find(s => s.id == studentId);
            if (student) {
                const studentName = student.first_name && student.last_name 
                    ? `${student.first_name} ${student.last_name}` 
                    : student.name || 'Unknown';
                alert(`Student Details:\nName: ${studentName}\nEmail: ${student.email}\nPoints: ${student.points || 0}\nLast Login: ${student.last_login || 'Never'}`);
            }
        }

        async function awardPoints(studentId) {
            const points = prompt('Enter points to award:');
            if (points && !isNaN(points) && points > 0) {
                try {
                    const response = await fetch(`${getApiUrl()}/admin/update-student-points`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            studentId: studentId,
                            points: parseInt(points),
                            action: 'add'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const student = courseAnalyticsData.students.find(s => s.id == studentId);
                        if (student) {
                            student.points = result.newPoints;
                            showToast(`Awarded ${points} points to ${student.name}. New total: ${result.newPoints}`, 'success');
                            refreshLeaderboard();
                        }
                    } else {
                        const error = await response.json();
                        showToast(`Error: ${error.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Error awarding points:', error);
                    showToast('Error awarding points', 'error');
                }
            }
        }

        // Auto-refresh functionality
        let autoRefreshInterval = null;
        
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                const activeSection = document.querySelector('.nav-link.active');
                if (activeSection) {
                    const section = activeSection.getAttribute('onclick').match(/'([^']+)'/)[1];
                    switch(section) {
                        case 'dashboard':
                            loadDashboard();
                            break;
                        case 'students':
                            loadStudents();
                            break;
                        case 'orders':
                            loadOrders();
                            break;
                        case 'enrollments':
                            loadEnrollments();
                            break;
                        case 'teachers':
                            loadTeachers();
                            break;
                    }
                }
            }, 30000); // Refresh every 30 seconds
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Export functionality
        function exportStudents() {
            try {
                const table = document.getElementById('studentsTable');
                const rows = Array.from(table.querySelectorAll('tr'));
                const csvContent = rows.map(row => {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    return cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
                }).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'students.csv';
                a.click();
                window.URL.revokeObjectURL(url);
                
                showToast('Students data exported successfully!', 'success');
            } catch (error) {
                showToast('Error exporting data: ' + error.message, 'error');
            }
        }
        
        function exportOrders() {
            try {
                const table = document.getElementById('ordersTable');
                const rows = Array.from(table.querySelectorAll('tr'));
                const csvContent = rows.map(row => {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    return cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
                }).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'orders.csv';
                a.click();
                window.URL.revokeObjectURL(url);
                
                showToast('Orders data exported successfully!', 'success');
            } catch (error) {
                showToast('Error exporting data: ' + error.message, 'error');
            }
        }
        
        // Initialize on page load
        // Show Add Course Modal
        function showAddCourseModal() {
            const modalHtml = `
                <div class="modal fade show" id="addCourseModal" style="display: block; background: rgba(0,0,0,0.5);" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Create New Course</h5>
                                <button type="button" class="btn-close btn-close-white" onclick="closeAddCourseModal()"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <strong>ðŸ“Œ Note:</strong> This will create a course in the database, a student dashboard page, and a content management page.
                                </div>
                                <form id="addCourseForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label"><strong>Course Title</strong> <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="courseTitle" placeholder="e.g., Chemistry IGCSE" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label"><strong>Short Name</strong> <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="courseShortName" placeholder="e.g., chemistry" required>
                                            <small class="text-muted">Used for file names (lowercase, no spaces)</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label"><strong>Instructor Name</strong></label>
                                            <input type="text" class="form-control" id="courseInstructor" placeholder="e.g., Dr. Smith">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label"><strong>Price (EGP)</strong> <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="coursePrice" placeholder="299" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label"><strong>Level</strong> <span class="text-danger">*</span></label>
                                            <select class="form-select" id="courseLevel" required>
                                                <option value="">Select level...</option>
                                                <option value="IGCSE">IGCSE</option>
                                                <option value="A-Level">A-Level</option>
                                                <option value="IB">IB</option>
                                                <option value="SAT">SAT</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label"><strong>Icon</strong></label>
                                            <select class="form-select" id="courseIcon">
                                                <option value="material-symbols:science">ðŸ§ª Science</option>
                                                <option value="material-symbols:calculate">ðŸ”¢ Mathematics</option>
                                                <option value="material-symbols:book">ðŸ“š Book</option>
                                                <option value="material-symbols:language">ðŸŒ Language</option>
                                                <option value="material-symbols:biotech">ðŸ§¬ Biology</option>
                                                <option value="material-symbols:public">ðŸŒ Geography</option>
                                                <option value="material-symbols:history-edu">ðŸ“œ History</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Description</strong></label>
                                        <textarea class="form-control" id="courseDescription" rows="3" placeholder="Brief description of the course"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeAddCourseModal()">Cancel</button>
                                <button type="button" class="btn btn-success" onclick="createCourse()">
                                    <i class="bi bi-check-circle me-1"></i>Create Course
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeAddCourseModal() {
            const modal = document.getElementById('addCourseModal');
            if (modal) modal.remove();
        }

        async function createCourse() {
            const title = document.getElementById('courseTitle').value.trim();
            const shortName = document.getElementById('courseShortName').value.trim().toLowerCase();
            const instructor = document.getElementById('courseInstructor').value.trim();
            const price = document.getElementById('coursePrice').value;
            const level = document.getElementById('courseLevel').value;
            const icon = document.getElementById('courseIcon').value;
            const description = document.getElementById('courseDescription').value.trim();

            if (!title || !shortName || !price || !level) {
                alert('Please fill in all required fields');
                return;
            }

            // Validate short name (lowercase, no spaces, alphanumeric)
            if (!/^[a-z0-9]+$/.test(shortName)) {
                alert('Short name must be lowercase alphanumeric only (no spaces or special characters)');
                return;
            }

            try {
                // Show loading state
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Creating...';

                // 1. Add course to database
                const response = await fetch(`${getApiUrl()}/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        instructor,
                        price: parseFloat(price),
                        level,
                        description,
                        icon,
                        is_active: true
                    })
                });

                if (!response.ok) throw new Error('Failed to create course in database');

                // 2. Create dashboard page
                const dashboardResponse = await fetch('/api/admin/create-course-pages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courseName: title,
                        shortName,
                        icon
                    })
                });

                if (!dashboardResponse.ok) throw new Error('Failed to create course pages');

                // Success!
                alert(`âœ… Course "${title}" created successfully!\n\nðŸ“„ Dashboard: ${shortName}-dashboard.html\nðŸ“ Content Manager: ${shortName}-content-manager.html`);
                
                closeAddCourseModal();
                loadCourses(); // Refresh course list
                loadDashboard(); // Refresh dashboard

            } catch (error) {
                console.error('Error creating course:', error);
                alert('Error creating course: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'r':
                            e.preventDefault();
                            const activeSection = document.querySelector('.nav-link.active');
                            if (activeSection) {
                                const section = activeSection.getAttribute('onclick').match(/'([^']+)'/)[1];
                                switch(section) {
                                    case 'dashboard':
                                        loadDashboard();
                                        break;
                                    case 'students':
                                        loadStudents();
                                        break;
                                    case 'orders':
                                        loadOrders();
                                        break;
                                    case 'enrollments':
                                        loadEnrollments();
                                        break;
                                    case 'teachers':
                                        loadTeachers();
                                        break;
                                }
                            }
                            break;
                        case 'e':
                            e.preventDefault();
                            const activeSection2 = document.querySelector('.nav-link.active');
                            if (activeSection2) {
                                const section2 = activeSection2.getAttribute('onclick').match(/'([^']+)'/)[1];
                                if (section2 === 'students') {
                                    exportStudents();
                                } else if (section2 === 'orders') {
                                    exportOrders();
                                }
                            }
                            break;
                    }
                }
            });
        });

        // ========== QUESTIONS MANAGEMENT FUNCTIONS ==========

        let currentQuestionCourse = '';

        function showAddQuestionModal() {
            if (!currentQuestionCourse) {
                alert('Please select a course first');
                return;
            }

            const modalHTML = `
                <div class="modal fade" id="addQuestionModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Add New Question - ${currentQuestionCourse.charAt(0).toUpperCase() + currentQuestionCourse.slice(1)}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addQuestionForm">
                                    <!-- Question Type -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Question Type:</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="questionType" id="typeText" value="text" checked onchange="toggleQuestionInput()">
                                            <label class="btn btn-outline-primary" for="typeText">
                                                <i class="bi bi-file-text me-2"></i>Text Question
                                            </label>
                                            <input type="radio" class="btn-check" name="questionType" id="typeImage" value="image" onchange="toggleQuestionInput()">
                                            <label class="btn btn-outline-primary" for="typeImage">
                                                <i class="bi bi-image me-2"></i>Image Question
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Text Question Input -->
                                    <div class="mb-3" id="textQuestionDiv">
                                        <label for="questionText" class="form-label fw-bold">Question Text:</label>
                                        <textarea class="form-control" id="questionText" rows="4" placeholder="Enter your question here..."></textarea>
                                    </div>

                                    <!-- Image Question Input -->
                                    <div class="mb-3" id="imageQuestionDiv" style="display: none;">
                                        <label for="questionImage" class="form-label fw-bold">Upload Question Image:</label>
                                        <input type="file" class="form-control" id="questionImage" accept="image/*" onchange="previewQuestionImage(event)">
                                        <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                                            <p class="text-muted">Preview:</p>
                                            <img id="imagePreview" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border: 2px solid #ddd; border-radius: 8px;">
                                        </div>
                                    </div>

                                    <!-- Question Category -->
                                    <div class="mb-3">
                                        <label for="questionCategory" class="form-label fw-bold">Category/Topic:</label>
                                        <input type="text" class="form-control" id="questionCategory" placeholder="e.g., Algebra, Mechanics, Grammar">
                                    </div>

                                    <!-- Difficulty Level -->
                                    <div class="mb-3">
                                        <label for="questionDifficulty" class="form-label fw-bold">Difficulty:</label>
                                        <select class="form-select" id="questionDifficulty">
                                            <option value="easy">Easy</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>

                                    <!-- Answer Type -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Answer Type:</label>
                                        <select class="form-select" id="answerType" onchange="toggleAnswerInput()">
                                            <option value="mcq">Multiple Choice (MCQ)</option>
                                            <option value="text">Text Answer</option>
                                        </select>
                                    </div>

                                    <!-- MCQ Options -->
                                    <div id="mcqOptionsDiv">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Options:</label>
                                            <input type="text" class="form-control mb-2" id="optionA" placeholder="Option A">
                                            <input type="text" class="form-control mb-2" id="optionB" placeholder="Option B">
                                            <input type="text" class="form-control mb-2" id="optionC" placeholder="Option C">
                                            <input type="text" class="form-control mb-2" id="optionD" placeholder="Option D">
                                        </div>
                                        <div class="mb-3">
                                            <label for="correctOption" class="form-label fw-bold">Correct Answer:</label>
                                            <select class="form-select" id="correctOption">
                                                <option value="A">Option A</option>
                                                <option value="B">Option B</option>
                                                <option value="C">Option C</option>
                                                <option value="D">Option D</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Text Answer -->
                                    <div id="textAnswerDiv" style="display: none;">
                                        <div class="mb-3">
                                            <label for="textAnswer" class="form-label fw-bold">Correct Answer:</label>
                                            <textarea class="form-control" id="textAnswer" rows="2" placeholder="Enter the correct answer"></textarea>
                                        </div>
                                    </div>

                                    <!-- Explanation -->
                                    <div class="mb-3">
                                        <label for="questionExplanation" class="form-label fw-bold">Explanation (Optional):</label>
                                        <textarea class="form-control" id="questionExplanation" rows="3" placeholder="Explain the correct answer"></textarea>
                                    </div>

                                    <!-- Points -->
                                    <div class="mb-3">
                                        <label for="questionPoints" class="form-label fw-bold">Points:</label>
                                        <input type="number" class="form-control" id="questionPoints" value="10" min="1" max="100">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveQuestion()">
                                    <i class="bi bi-save me-2"></i>Save Question
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('addQuestionModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addQuestionModal'));
            modal.show();
        }

        function toggleQuestionInput() {
            const questionType = document.querySelector('input[name="questionType"]:checked').value;
            const textDiv = document.getElementById('textQuestionDiv');
            const imageDiv = document.getElementById('imageQuestionDiv');

            if (questionType === 'text') {
                textDiv.style.display = 'block';
                imageDiv.style.display = 'none';
            } else {
                textDiv.style.display = 'none';
                imageDiv.style.display = 'block';
            }
        }

        function toggleAnswerInput() {
            const answerType = document.getElementById('answerType').value;
            const mcqDiv = document.getElementById('mcqOptionsDiv');
            const textDiv = document.getElementById('textAnswerDiv');

            if (answerType === 'mcq') {
                mcqDiv.style.display = 'block';
                textDiv.style.display = 'none';
            } else {
                mcqDiv.style.display = 'none';
                textDiv.style.display = 'block';
            }
        }

        function previewQuestionImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function saveQuestion() {
            const questionType = document.querySelector('input[name="questionType"]:checked').value;
            let questionContent = '';

            if (questionType === 'text') {
                questionContent = document.getElementById('questionText').value.trim();
                if (!questionContent) {
                    alert('Please enter the question text');
                    return;
                }
            } else {
                const imageFile = document.getElementById('questionImage').files[0];
                if (!imageFile) {
                    alert('Please upload a question image');
                    return;
                }
                // Convert image to base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    questionContent = e.target.result;
                    saveQuestionData(questionType, questionContent);
                };
                reader.readAsDataURL(imageFile);
                return; // Exit here, will continue in reader.onload
            }

            saveQuestionData(questionType, questionContent);
        }

        function saveQuestionData(questionType, questionContent) {
            const answerType = document.getElementById('answerType').value;
            const category = document.getElementById('questionCategory').value.trim();
            const difficulty = document.getElementById('questionDifficulty').value;
            const points = document.getElementById('questionPoints').value;
            const explanation = document.getElementById('questionExplanation').value.trim();

            let answer = {};
            if (answerType === 'mcq') {
                answer = {
                    type: 'mcq',
                    options: {
                        A: document.getElementById('optionA').value.trim(),
                        B: document.getElementById('optionB').value.trim(),
                        C: document.getElementById('optionC').value.trim(),
                        D: document.getElementById('optionD').value.trim()
                    },
                    correct: document.getElementById('correctOption').value
                };

                if (!answer.options.A || !answer.options.B || !answer.options.C || !answer.options.D) {
                    alert('Please fill in all MCQ options');
                    return;
                }
            } else {
                const textAnswer = document.getElementById('textAnswer').value.trim();
                if (!textAnswer) {
                    alert('Please enter the correct answer');
                    return;
                }
                answer = {
                    type: 'text',
                    correct: textAnswer
                };
            }

            const question = {
                id: Date.now(),
                type: questionType,
                content: questionContent,
                category: category || 'General',
                difficulty: difficulty,
                answer: answer,
                explanation: explanation,
                points: parseInt(points),
                createdAt: new Date().toISOString()
            };

            // Save to localStorage
            const storageKey = `${currentQuestionCourse}Questions`;
            const questions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            questions.push(question);
            localStorage.setItem(storageKey, JSON.stringify(questions));

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addQuestionModal'));
            modal.hide();

            // Reload questions
            loadQuestions(currentQuestionCourse);

            alert('Question added successfully!');
        }

        function loadQuestions(course) {
            if (!course) {
                document.getElementById('questionsListContainer').innerHTML = '<p class="text-muted text-center">Please select a course to view questions</p>';
                return;
            }

            currentQuestionCourse = course;
            const storageKey = `${course}Questions`;
            const questions = JSON.parse(localStorage.getItem(storageKey) || '[]');

            if (questions.length === 0) {
                document.getElementById('questionsListContainer').innerHTML = '<p class="text-muted text-center">No questions added yet. Click "Add New Question" to create one.</p>';
                return;
            }

            let html = '<div class="accordion" id="questionsAccordion">';
            questions.forEach((q, index) => {
                const questionPreview = q.type === 'text' 
                    ? q.content.substring(0, 100) + (q.content.length > 100 ? '...' : '')
                    : '<i class="bi bi-image me-2"></i>Image Question';

                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#question${q.id}">
                                <span class="badge bg-${q.difficulty === 'easy' ? 'success' : q.difficulty === 'medium' ? 'warning' : 'danger'} me-2">${q.difficulty}</span>
                                <span class="badge bg-info me-2">${q.category}</span>
                                ${questionPreview}
                            </button>
                        </h2>
                        <div id="question${q.id}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#questionsAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <strong>Question:</strong><br>
                                    ${q.type === 'text' ? q.content : `<img src="${q.content}" alt="Question" style="max-width: 100%; max-height: 400px; border: 2px solid #ddd; border-radius: 8px;">`}
                                </div>
                                <div class="mb-3">
                                    <strong>Answer Type:</strong> ${q.answer.type === 'mcq' ? 'Multiple Choice' : 'Text Answer'}<br>
                                    ${q.answer.type === 'mcq' ? `
                                        <strong>Options:</strong><br>
                                        A) ${q.answer.options.A}<br>
                                        B) ${q.answer.options.B}<br>
                                        C) ${q.answer.options.C}<br>
                                        D) ${q.answer.options.D}<br>
                                        <strong class="text-success">Correct: ${q.answer.correct}</strong>
                                    ` : `<strong class="text-success">Correct Answer: ${q.answer.correct}</strong>`}
                                </div>
                                ${q.explanation ? `<div class="mb-3"><strong>Explanation:</strong> ${q.explanation}</div>` : ''}
                                <div class="mb-3">
                                    <span class="badge bg-primary">Points: ${q.points}</span>
                                    <span class="badge bg-secondary ms-2">Created: ${new Date(q.createdAt).toLocaleDateString()}</span>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="deleteQuestion('${course}', ${q.id})">
                                    <i class="bi bi-trash me-2"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('questionsListContainer').innerHTML = html;
        }

        function deleteQuestion(course, questionId) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }

            const storageKey = `${course}Questions`;
            let questions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            questions = questions.filter(q => q.id !== questionId);
            localStorage.setItem(storageKey, JSON.stringify(questions));

            loadQuestions(course);
            alert('Question deleted successfully!');
        }

        // ========== END QUESTIONS MANAGEMENT FUNCTIONS ==========
    </script>
</body>
</html>

